Establishing persistence on Linux

In order to use the Metasploit persistence modules, we will first need to elevate our privileges on the Linux target.

Of course, the way this is achieved will be different in each scenario. Once you have elevated your privilege, we will do the following

In this particular lab, the target is running ssh, and we got into the system through ssh. Then we used chkrootkit on the active session to elevate our rights. 

Now that we have been able to elevate our privileges on the target system, we can begin exploring the process of establishing persistence.

The best Metasploit module that can be used to establish persistent access on a Linux target is the sshkey_persistence module.

We can load the module by running the following command:
-use post/linux/manage/sshkey_persistence
- set SESSION
-set CREATESSHFOLDER true

If the module runs successfully and will add a public SSH key to the authorized_keys file in the home directory of all user and service accounts.

We can view the newly created private key that can be used to authenticate with the target system by running the following command:

-loot
the loot command reveals the location of the private key that can be used to authenticate with the target system via SSH without providing a password.

In order to use the private key, you will need to view the content of the loot file, copy the key and save it as a new file,
in this case, we will be saving it in the home directory of the root user on the Kali Linux system as ssh_key.

We will then need to assign the appropriate permissions to the file, this can be done by running the following commands:
-chmod 0400 ssh_key

then
-ssh -i ssh_key root@<TARGET>

the authentication with the private key is successful and we have successfully been able to establish persistent access to the Linux target by adding 
our own public key to the authorized_keys file of over user account, consequently allowing us to authenticate with the target via SSH without providing
a password.
